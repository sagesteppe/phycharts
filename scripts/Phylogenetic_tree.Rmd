---
title: "Phylogenetic_coverage_RMBL"
author: "Reed"
date: "3/28/2021"
output: pdf_document
---


Althought the pie chart has mostly been relegated as a data visualization tool of the past, I think that is occasionally still does have it's uses. Acomplication with the size o



To show the extent of the available A353 sequence data, relative to the taxa at RMBL we will create a circular phylogenetic tree, and then place a circle plot indicating PRESENCE or ABSENCE of a sequence for the genus. 

This will require 3 sets of data:
A) The Current list of all PAFTOL sequence data. 
B) Our additional sequences
C) The Vascular Plant Checklist for RMBL. 

We will then make these data more coarse, to the resolution of genus. Naturally we will subset PAFTOL to the genera at RMBL to reduce extraneous tips hence branches. 


```{r Install GGTREE if needed, eval = F, echo = F}
install.packages('BiocManager')
BiocManager::install("ggtree") #to download ggtreee use this 
```

```{r library, results = 'hide', message = F, warning = F, echo = FALSE}
library(tidyverse)
library(ggtree)
library(rotl)
library(ggnewscale)
library(taxizedb)
library(ggimage)
```

Molecular import and wrangle. 
```{r import molecular data & wrangle - Molecular}
non_biotic <- read.csv("../data/non_biotic_poll.csv")[,2]

rmbl_plants <- read.csv('../data/gothic_plant_list.csv') %>% 
  group_by(genus) %>% 
  mutate(no_species = n()) %>% 
  dplyr::select(-species) %>% 
  filter(!family %in% non_biotic) %>% 
  ungroup() %>% 
  mutate(taxid = name2taxid(binomial, db = 'ncbi'))

rmbl_genera <- rmbl_plants %>% 
  distinct(genus) %>% 
  pull(genus) 

eastwood_summary <- read.delim('../data/eastwood_db_summary.csv', header = F, 
                               col.names = c('prc_mini_map2_root', 'no_mini_root', 
                                             'no_mini_map_clade', 'rank', 'taxid', 'taxon') 
                               ) %>% 
  mutate(taxon = str_trim(taxon)) %>% 
  filter(rank == 'S',!taxid %in% c(7, 13055)) %>% 
  separate(taxon, into = c('genus', 'species'), extra = "drop") %>% 
  group_by(genus) %>% 
  mutate(no_species = n()) %>% 
  dplyr::select(-species) %>% 
  distinct() %>% 
  ungroup() 

```

Morphological Import and wrangle
```{r, import data & wrangle - Morphological, warning = F}

new <- read.csv("../data/Pollen_Label_box.csv") %>% 
  separate(Taxon, into = c('genus', 'species'), extra = "drop") %>% 
  select(genus, Family)
  
old <- read.csv("../data/existing_pollen_reference_slides.csv") %>% 
  select('genus' = Genus, Family)

pollen_slides <- rbind(new, old)

rm(new, old)
```

Retrieve OTT id's to request an Open Tree of Life Phylogeny. We will not be able to retrieve non-monophyletic genera, so we will try to pull out a single species from each genus and search for thata so we can at lest have some thing...

```{r Find Tree, results = 'hide', message = F, warning = F}
resolved_names <- tnrs_match_names(rmbl_genera, context = "Land plants")
resolved_names$in_tree <- is_in_tree(resolved_names$ott_id) # this will tell us whether the genus is in the tree. A number of genera will be false, because they are not monophyletic, but we should be able to recover a single species from the genus for our purposes. 

non_monophyletic_genera <- resolved_names %>% 
  filter(in_tree == "FALSE")  %>% 
  pull(unique_name)
non_monophyletic_genera <- as.vector(non_monophyletic_genera)

species_to_q <- rmbl_plants %>% 
  filter(genus %in% non_monophyletic_genera) %>% 
  group_by(genus) %>% 
  sample_n(1) %>% 
  pull(binomial)

rmbl_genera1 <- rmbl_genera[!rmbl_genera %in% non_monophyletic_genera]
rmbl_queries <- c(rmbl_genera1, species_to_q)

rmbl_queries <- rmbl_queries %>% 
  str_replace("Actaea", "actaea rubra") %>%  # I ran the code below, and came back to fix these by hand
  str_replace("Urtica", "urtica dioica") %>%  # fix a few records by hand...
  str_replace("Viola", "Viola praemorsa") %>%  # just threw in random names,
  str_replace("Heuchera", "heuchera cylindrica")

resolved_names <- tnrs_match_names(rmbl_queries, context = "Land plants")
resolved_names <- resolved_names %>% drop_na(ott_id)
resolved_names$in_tree <- is_in_tree(resolved_names$ott_id)
# our tree misses two genera of 298, not bad...
resolved_names <- resolved_names %>% filter(in_tree == "TRUE")

tree <- tol_induced_subtree(ott_ids = resolved_names$ott_id)

tree[["tip.label"]] <- sub("_.*", "",tree[["tip.label"]])
tip_label_order <- as.data.frame(sub("_.*", "",tree[["tip.label"]])) # we need these to annotate the tree. 
colnames(tip_label_order) <- "genus"

rm(non_monophyletic_genera, rmbl_queries, rmbl_genera1, resolved_names, species_to_q, rmbl_plants, rmbl_plants)
```

We can plot the entirety of the taxa for which we have the tree with names and the nodes labelled. 

```{r Plot a phylogenetic tree with named nodes}

rmbl_tree <- ggtree(tree, size=1.0, branch.length='none', layout='circular')
rmbl_named <- ggtree(tree, branch.length='none', layout='circular') +
  geom_tiplab(size = 3) + 
  geom_text(aes(label=node)) 


rotate(rmbl_named, 348)

ggsave('named_tree.png', device = 'png', width = 24, height = 24, units = 'in')

rm( rmbl_named)
```

Annotate tree and things
```{r Molecular Tree, message = F}
sequenced <- eastwood_summary %>% 
  dplyr::select(genus) %>% 
  distinct() %>% 
  mutate(SEQUENCED = 'sequenced')

grouptreeSEQ <- left_join(tip_label_order, sequenced, by = "genus")%>% 
  mutate(SEQUENCED = replace_na(SEQUENCED, replace = 'lacking')) %>% 
  dplyr::select(SEQUENCED)
rownames(grouptreeSEQ) <- tree$tip.label

gheatmap(rmbl_tree, grouptreeSEQ, colnames = F, offset=0.1, width=.25,
                low = "#D8B70A", high = "lightseagreen", color = "#CEAB07") +
      theme(legend.position="none",
        plot.title = element_text(hjust = 0.5)) +
  ggtitle("Biotically Pollinated Plant Genera \n at RMBL with Molecular Vouchers") 

#ggsave("phylo_test.png")
```

```{r, Morphological Tree}
pollen_slides_prepped <- pollen_slides %>% 
  dplyr::select(genus) %>% 
  distinct() %>% 
  mutate(SLIDE = 'slide') 

grouptreeMORPH <- left_join(tip_label_order, pollen_slides_prepped, by = "genus")%>% 
  mutate(SLIDE = replace_na(SLIDE, replace = 'lacking')) %>% 
  dplyr::select(SLIDE)
rownames(grouptreeMORPH) <- tree$tip.label

tp2 <- gheatmap(rmbl_tree, grouptreeMORPH, colnames = F, offset=.01, width=.2,
                low = "maroon3", high = "limegreen", color = "lightgoldenrod1") +
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5)) +
  ggtitle("Biotically Pollinated Plant Genera \n at RMBL with Voucher Slides") 
  #scale_color_manual(name = "Voucher Status")

tp2

# ggsave("pollen_slides_morpho.png", tp2, bg = "transparent")
```





```{r Colors for edges}


node_dist <- data.frame(
  node = c(
    c(350:376, 105:156), # Asterales
    c(445, 240:241), # Alismatales
    c(429:440, 221:233), # Asparagales
    c(377:382, 157:165), # Apiales
    c(336:340, 90:95), # Boraginales
    c(282:298, 35:52), # Brassicales
    c(398:411, 186:205), #Caryophyllales
    c(255,8:9),  # Celastrales
    c(185), # Cornales
    c(383:388, 166:171),  # Dipsacales
    c(389:397, 172:184), # Ericales
    c(270:278, 24:33), # Fabales
    c(342:348, 97:104), # Gentianales
    c(55), # geraniales
    c(318:335, 70:89), # Lamiales
    c(441:444, 234:238), # Liliales
    c(249:254, 1:7), # Malpighiales
    c(299, 53:54), # Malvales
    c(301:304, 56:60), # Myrtales
    c(412:424, 206:219), # Ranunculales
    c(257:269, 10:23), # Rosales
    c(34), # sapindales
    c(305:312, 61:69), # saxifragaceae
    c(220) # zingiberales
  ),
  order = c(
    rep("Asterales", each = length(c(350:376, 105:156))),
    rep("Alismatales", each = length(c(445, 240:241))),
    rep("Asparagales", each = length(c(429:440, 221:233))),
    rep("Apiales", each = length(c(377:382, 157:165))),
    rep("Boraginales", each = length(c(336:340, 90:95))),
    rep("Brassicales", each = length(c(282:298, 35:52))),
    rep("Caryophyllales", each = length(c(398:411, 186:205))), 
    rep("Celastrales", each = length(c(255,8:9))), 
    rep("Cornales", each = length(c(185))),
    rep("Dipsacales", each = length(c(383:388, 166:171))),
    rep("Ericales", each = length(c(389:397, 172:184))),
    rep("Fabales", each = length(c(270:278, 24:33))),
    rep("Gentianales", each = length(c(342:348, 97:104))),
    rep('Geraniales', each = length(c(55))),
    rep("Lamiales", each = length(c(318:335, 70:89))),
    rep("Liliales", each = length(c(441:444, 234:238))),
    rep("Malpighiales", each = length(c(249:254, 1:7))), 
    rep("Malvales", each = length(c(299, 53:54))),
    rep("Myrtales", each = length(c(301:304, 56:60))), 
    rep("Ranunculales", each = length(c(412:424, 206:219))),
    rep("Rosales", each = length(c(257:269, 10:23))),
    rep("Sapindales", each = length(c(34))),
    rep('Saxifragaceae', each = length(c(305:312, 61:69))),
    rep('Zingiberales', each = length(c(220)))
  )
)


color_palette_map <- data.frame(
  order =  c("Asterales", "Alismatales",  "Asparagales", "Apiales", "Boraginales", 
             "Brassicales", "Caryophyllales", "Celastrales", "Cornales", "Dipsacales", 
             "Ericales", "Fabales", "Gentianales", "Lamiales", "Liliales", 
             "Malpighiales", "Malvales", "Myrtales", "Ranunculales", "Rosales", 
             "Sapindales", 'Saxifragaceae', 'Zingiberales'),
  color = c(sample(colors(), size =  23))
)

node_dist <- left_join(node_dist, color_palette_map, by = 'order')

```


```{r Consensus tree both morpho and molecular}

labDataDF <- cbind(grouptreeMORPH, grouptreeSEQ)

ob <- gheatmap(rmbl_tree, labDataDF, offset=.8, width=.2,
               colnames_angle=95, colnames_offset_y = .25, colnames = F) +
  scale_fill_manual('Status', values = c('grey95', 'lightseagreen', 'maroon3')) +

  theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("Biotically Pollinated Plant Genera \n which had morphological or molecular data")

ob1 <- ob %<+% 
  node_dist + aes(color=I(color)) 
rotate(ob1, 348) +
  geom_cladelab(node=440, label="Liliales", angle='auto', color='white',
               offset=7, offset.text = 1, align = T, horizontal = F) +
  geom_cladelab(node=412, label="Ranunculales", , angle='auto', color='white',
               offset=7, offset.text = 1, align = T, horizontal = F) +
  geom_cladelab(node=282, label="Brassicales", angle=0, color='white',
              offset=7, offset.text = 1,  align = T) +
  geom_cladelab(node=270, label="Fabales", angle=30, color='white',
               offset=7, offset.text = 1) +
  geom_cladelab(node=257, label="Rosales", angle=50, color='white',
               offset=7, offset.text = 1) +
  geom_cladelab(node=398, label="Caryophyllales", angle=270, color='white',
              offset=7, offset.text = 1) +
  geom_cladelab(node=389, label="Ericales", angle=295, color='white',
              offset=7, offset.text = 1) +
  geom_cladelab(node=336, label="Boraginales", angle=318, color='white',
              offset=7, offset.text = 1) +
  geom_cladelab(node=377, label="Apiales", angle='auto', color='white',
               offset=7, offset.text = 1, align = T, horizontal = F) +
  geom_cladelab(node=350, label="Asterales", angle='auto', color='white',
               offset=7, offset.text = 1, align = T, horizontal = F) 

```
























```{r}

newick <- paste0("((Pongo_abelii,(Gorilla_gorilla_gorilla,(Pan_paniscus,",
          "Pan_troglodytes)Pan,Homo_sapiens)Homininae)Hominidae,",
          "Nomascus_leucogenys)Hominoidea;")

tree <- read.tree(text=newick)

d <- ggimage::phylopic_uid(tree$tip.label)
d$body_mass <- c(52, 114, 47, 45, 58, 6)


p <- ggtree(tree) %<+% d + 
  geom_tiplab(aes(image=uid, colour=body_mass), geom="phylopic", offset=2.5) +
  geom_tiplab(aes(label=label), offset = .2) + xlim(NA, 7) + # we can use angle = 90 o turn the object
  scale_color_viridis_c()

p

```

